# 🔧 问题修复说明

## 已修复的问题

### ✅ 问题1：Vercel上股票价格和图表不显示

**原因分析**：
- HTML中所有API调用都硬编码了`http://localhost:5001`
- 在Vercel部署后，这些API调用无法正确指向Vercel的Serverless API

**修复方案**：
1. 修改 [config.js](config.js)，使API_BASE_URL自动使用当前域名：
   ```javascript
   API_BASE_URL: window.location.origin  // 生产环境自动使用当前域名
   ```

2. 在 [portfolio-tracker.html](portfolio-tracker.html) 中添加config.js引用：
   ```html
   <script src="config.js"></script>
   ```

3. 修改所有硬编码的API调用（共6处）：
   ```javascript
   // 修改前
   const url = `http://localhost:5001/api/price/${symbol}`;

   // 修改后
   const apiUrl = window.APP_CONFIG ? window.APP_CONFIG.API_BASE_URL : 'http://localhost:5001';
   const url = `${apiUrl}/api/price/${symbol}`;
   ```

**修复位置**：
- `checkAPIStatus()` - API健康检查
- `fetchReal30DayHistory()` - 获取30天历史数据
- `fetchFromLocalAPI()` - 获取股票价格
- `fetchHistoricalFromLocalAPIByPeriod()` - 获取历史数据（按周期）
- 另外2处历史数据获取函数

---

### ✅ 问题2：多端数据不同步（手机和电脑数据不一致）

**原因分析**：
- 前端没有集成云端同步功能
- 数据只保存在浏览器的localStorage
- config.js中DATABASE_TYPE设置为'localstorage'而非'mongodb'

**修复方案**：

1. **启用MongoDB数据库**
   - 修改 [config.js](config.js)：
     ```javascript
     DATABASE_TYPE: 'mongodb'  // 改为使用MongoDB云端存储
     ```

2. **添加云端同步模块引用**
   - 在HTML中添加：
     ```html
     <script src="cloud-sync.js"></script>
     ```

3. **集成云端同步初始化**
   - 在`window.onload`开头添加云端同步初始化：
     ```javascript
     await initCloudSync();
     ```

4. **添加云端同步函数**
   - `initCloudSync()` - 初始化云端同步，从云端加载数据
   - `syncToCloud()` - 将数据同步到云端
   - 重写`savePortfolio()`、`saveCashBalance()`、`saveTransactionHistory()`函数，自动同步到云端

**工作流程**：
```
页面加载
  ↓
从云端加载数据 → MongoDB
  ↓
显示数据
  ↓
用户修改数据
  ↓
保存到localStorage + 同步到MongoDB
  ↓
其他设备刷新页面 → 从MongoDB加载最新数据
```

---

## 🚀 部署更新

修复完成后，需要重新部署到Vercel：

```bash
# 1. 提交更改
git add .
git commit -m "修复Vercel部署问题和云端同步功能"
git push

# 2. Vercel会自动检测并重新部署
# 或者手动在Vercel Dashboard触发重新部署
```

---

## ✅ 验证修复

### 验证问题1（API调用）

1. 打开浏览器控制台（F12）
2. 查看Network标签
3. 添加一个股票
4. 应该看到API调用指向你的Vercel域名，而不是localhost:5001

预期输出：
```
请求URL: https://your-app.vercel.app/api/price/AAPL
```

### 验证问题2（多端同步）

1. **在电脑上**：
   - 打开你的Vercel网址
   - 添加一个持仓（例如AAPL，100股）
   - 打开控制台，应该看到：
     ```
     ✅ 从云端加载数据
     ☁️ 正在同步到云端...
     ✅ 已同步到云端
     ```

2. **在手机上**：
   - 打开相同的Vercel网址
   - 应该能看到刚才添加的AAPL持仓
   - 控制台应该显示：
     ```
     ✅ 从云端加载数据
     ```

3. **测试双向同步**：
   - 在手机上修改或添加持仓
   - 回到电脑刷新页面
   - 应该能看到手机上的修改

---

## ⚠️ 重要提示

### MongoDB环境变量

确保在Vercel项目设置中配置了MongoDB环境变量：

```
变量名: MONGODB_URI
变量值: mongodb+srv://username:password@cluster.mongodb.net/...
```

没有这个环境变量，云端同步功能将无法工作。

### 检查方法

在Vercel Dashboard：
1. 进入你的项目
2. 点击 "Settings"
3. 点击 "Environment Variables"
4. 确认 `MONGODB_URI` 已配置

---

## 🐛 如果还有问题

### API调用失败

**检查**：
- 打开浏览器控制台查看错误信息
- 查看Vercel项目日志（Dashboard → Logs）
- 确认 `config.js` 和 `cloud-sync.js` 已正确加载

**解决**：
```javascript
// 在控制台检查
console.log(window.APP_CONFIG);  // 应该显示配置对象
console.log(typeof CloudSync);   // 应该是 'function'
```

### 云端同步不工作

**检查**：
1. MongoDB URI是否正确配置
2. 网络是否可访问MongoDB
3. 查看Vercel函数日志

**解决**：
```javascript
// 在控制台手动测试
await cloudSync.loadFromCloud();  // 应该返回数据或null
await cloudSync.saveToCloud({positions: [], cashBalance: 0});  // 应该返回true
```

### 数据不一致

**解决方案**：
1. 清除浏览器缓存
2. 在控制台运行：
   ```javascript
   localStorage.clear();
   location.reload();
   ```
3. 重新从云端加载数据

---

## 📝 技术细节

### 修改的文件

1. **config.js** - API配置
2. **portfolio-tracker.html** - 主页面
   - 添加了config.js和cloud-sync.js引用
   - 修改了所有API调用
   - 添加了云端同步功能

### 代码改动统计

- 修改：2个文件
- 新增代码：约150行
- API调用修复：6处
- 新增功能：云端同步初始化和自动同步

---

## ✨ 现在的功能

修复后，你的应用现在支持：

1. ✅ **本地运行** - `python app.py`
2. ✅ **Vercel部署** - 股价和图表正常显示
3. ✅ **多端同步** - 手机和电脑数据实时同步
4. ✅ **离线缓存** - 本地LocalStorage备份
5. ✅ **云端存储** - MongoDB Atlas持久化

---

**修复完成！** 🎉

现在可以重新部署到Vercel，问题应该已经解决。
